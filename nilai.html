<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nilai - SIKELAS XI MIPA 1</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            text-align: left;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            font-weight: 600;
            white-space: nowrap;
        }
        .data-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .grade-a { color: var(--success); font-weight: bold; }
        .grade-b { color: var(--accent); font-weight: bold; }
        .grade-c { color: var(--warning); font-weight: bold; }
        .grade-d { color: var(--danger); font-weight: bold; }

        /* Teacher Inputs */
        .grade-input {
            width: 50px;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 6px;
            text-align: center;
        }
        .grade-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .action-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
            gap: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">ğŸ“</span>
                    <h2>SIK</h2>
                </div>
                <p class="class-name">XI MIPA 1</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span><span class="nav-text">Home</span></a></li>
                <li class="nav-item"><a href="biodata.html" class="nav-link"><span class="nav-icon">ğŸ‘¤</span><span class="nav-text">Profil Saya</span></a></li>
                <li class="nav-item"><a href="struktur.html" class="nav-link"><span class="nav-icon">ğŸ›ï¸</span><span class="nav-text">Struktur</span></a></li>
                <li class="nav-item"><a href="piket.html" class="nav-link"><span class="nav-icon">ğŸ§¹</span><span class="nav-text">Piket</span></a></li>
                <li class="nav-item"><a href="absensi.html" class="nav-link"><span class="nav-icon">ğŸ“‹</span><span class="nav-text">Absensi</span></a></li>
                <li class="nav-item"><a href="nilai.html" class="nav-link active"><span class="nav-icon">ğŸ“Š</span><span class="nav-text">Nilai</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                    <p>Wali Kelas</p>
                    <p style="color: var(--text-main); font-weight: 500;">Bu Siti Aminah, S.Pd</p>
                    <p style="font-size: 10px; opacity: 0.7;">NISN: 198501282010012009</p>
                </div>
                <button onclick="logoutUser()" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%;">ğŸšª Keluar</button>
            </div>
        </nav>
        
        <main class="main-content">
            <h1 class="hero-title" style="font-size: 28px; margin-bottom: 8px;">ğŸ“Š Nilai Siswa</h1>
            <p style="color: var(--text-muted); margin-bottom: 32px;">Rekap Nilai Semester Ganjil 2024/2025</p>
            
            <!-- TEACHER ACTION BAR (Hidden by default) -->
            <div id="teacherActions" class="action-bar" style="display: none;">
                <button onclick="handleAddStudent()" class="btn-secondary" style="font-size: 14px; padding: 8px 16px;">+ Tambah Siswa</button>
                <button onclick="handleSaveData()" class="btn-primary" style="font-size: 14px; padding: 8px 16px;">ğŸ’¾ Simpan Perubahan</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Rekap Nilai Per Mapel</h3>
                    <span class="badge">UTS + UAS</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th class="text-center">MTK</th>
                                <th class="text-center">FIS</th>
                                <th class="text-center">KIM</th>
                                <th class="text-center">BIO</th>
                                <th class="text-center">IND</th>
                                <th class="text-center">ING</th>
                                <th class="text-center">RataÂ²</th>
                            </tr>
                        </thead>
                        <tbody id="nilaiTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </main>
    </div>

    <!-- SCRIPT -->
    <script src="js/data.js"></script>
    <script>
        checkAuth();
        const user = getCurrentUser();
        const isTeacher = user.role === 'teacher';

        // 1. Setup UI
        if (isTeacher) {
            document.getElementById('teacherActions').style.display = 'flex';
        } else {
            document.getElementById('teacherActions').style.display = 'none';
        }

        // 2. Render Table
        function renderTable() {
            const tbody = document.getElementById('nilaiTableBody');
            tbody.innerHTML = '';
            
            // Get fresh data
            const currentStudents = getStudents(); // From localStorage

            currentStudents.forEach((s, index) => {
                const tr = document.createElement('tr');
                
                // Grades helper
                const g = s.grades;
                const avg = ((parseInt(g.mtk) + parseInt(g.fis) + parseInt(g.kim) + parseInt(g.bio) + parseInt(g.ind) + parseInt(g.ing)) / 6).toFixed(1);
                
                // Color for Avg
                let avgClass = 'grade-c';
                if (avg >= 90) avgClass = 'grade-a';
                else if (avg >= 80) avgClass = 'grade-b';

                let rowHtml = `<td>${index + 1}</td>
                               <td>${s.name} <br> <small style="color:var(--text-muted); font-size:10px;">${s.nis}</small></td>`;
                
                if (isTeacher) {
                    // EDITABLE INPUTS
                    rowHtml += `
                        <td class="text-center"><input type="number" class="grade-input" value="${g.mtk}" data-id="${s.id}" data-mapel="mtk"></td>
                        <td class="text-center"><input type="number" class="grade-input" value="${g.fis}" data-id="${s.id}" data-mapel="fis"></td>
                        <td class="text-center"><input type="number" class="grade-input" value="${g.kim}" data-id="${s.id}" data-mapel="kim"></td>
                        <td class="text-center"><input type="number" class="grade-input" value="${g.bio}" data-id="${s.id}" data-mapel="bio"></td>
                        <td class="text-center"><input type="number" class="grade-input" value="${g.ind}" data-id="${s.id}" data-mapel="ind"></td>
                        <td class="text-center"><input type="number" class="grade-input" value="${g.ing}" data-id="${s.id}" data-mapel="ing"></td>
                        <td class="text-center"><span class="${avgClass}">${avg}</span></td>
                    `;
                } else {
                    // READ ONLY
                    rowHtml += `
                        <td class="text-center ${getGradeClass(g.mtk)}">${g.mtk}</td>
                        <td class="text-center ${getGradeClass(g.fis)}">${g.fis}</td>
                        <td class="text-center ${getGradeClass(g.kim)}">${g.kim}</td>
                        <td class="text-center ${getGradeClass(g.bio)}">${g.bio}</td>
                        <td class="text-center ${getGradeClass(g.ind)}">${g.ind}</td>
                        <td class="text-center ${getGradeClass(g.ing)}">${g.ing}</td>
                        <td class="text-center"><span class="${avgClass}">${avg}</span></td>
                    `;
                }
                
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
            
            // Only highlight if student
            if (!isTeacher) highlightCurrentUser(); 
        }

        function getGradeClass(val) {
            if (val >= 90) return 'grade-a';
            if (val >= 80) return 'grade-b';
            if (val >= 70) return 'grade-c';
            return 'grade-d';
        }

        // 3. Teacher Actions
        function handleSaveData() {
            if (!confirm('Simpan perubahan nilai?')) return;
            
            const inputs = document.querySelectorAll('.grade-input');
            const dataToUpdate = getStudents(); // Get current state
            
            inputs.forEach(input => {
                const id = input.getAttribute('data-id');
                const mapel = input.getAttribute('data-mapel');
                const val = input.value;
                
                // Find student to update
                const student = dataToUpdate.find(s => s.id === id);
                if (student) {
                    student.grades[mapel] = Number(val);
                }
            });
            
            saveStudents(dataToUpdate);
            alert('Data berhasil disimpan! ğŸ’¾');
            renderTable(); // Re-render to update averages
        }

        function handleAddStudent() {
            const name = prompt("Masukkan Nama Siswa Baru:");
            if (!name) return;
            
            const nis = prompt("Masukkan NIS:");
            if (!nis) return;
            
            const gender = prompt("Jenis Kelamin (Laki-laki/Perempuan):", "Laki-laki");
            
            // Add to DB
            addStudent(name, nis, gender);
            renderTable();
        }

        // Init
        renderTable();
    </script>
</body>
</html>
