<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi - SIKELAS XI MIPA 1</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            text-align: left;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            font-weight: 600;
        }
        .data-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px; font-weight: bold;
            color: white;
            min-width: 30px; text-align: center;
        }
        .status-hadir { background: var(--success); }
        .status-izin { background: var(--warning); }
        .status-sakit { background: var(--secondary); }
        .status-alpha { background: var(--danger); }
        
        .grade-a { color: var(--success); font-weight: bold; }
        .grade-b { color: var(--warning); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">ğŸ“</span>
                    <h2>SIK</h2>
                </div>
                <p class="class-name">XI MIPA 1</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span><span class="nav-text">Home</span></a></li>
                <li class="nav-item"><a href="biodata.html" class="nav-link"><span class="nav-icon">ğŸ‘¤</span><span class="nav-text">Profil Saya</span></a></li>
                <li class="nav-item"><a href="struktur.html" class="nav-link"><span class="nav-icon">ğŸ›ï¸</span><span class="nav-text">Struktur</span></a></li>
                <li class="nav-item"><a href="piket.html" class="nav-link"><span class="nav-icon">ğŸ§¹</span><span class="nav-text">Piket</span></a></li>
                <li class="nav-item"><a href="absensi.html" class="nav-link active"><span class="nav-icon">ğŸ“‹</span><span class="nav-text">Absensi</span></a></li>
                <li class="nav-item"><a href="nilai.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span class="nav-text">Nilai</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                    <p>Wali Kelas</p>
                    <p style="color: var(--text-main); font-weight: 500;">Abdillah Rifai S.Kom</p>
                    <p style="font-size: 10px; opacity: 0.7;">NISN: 198501282010012009</p>
                </div>
                <button onclick="logoutUser()" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%;">ğŸšª Keluar</button>
            </div>
        </nav>
        
        <main class="main-content">
            <h1 class="hero-title" style="font-size: 28px; margin-bottom: 8px;">ğŸ“‹ Rekap Absensi</h1>
            <p style="color: var(--text-muted); margin-bottom: 32px;">Kehadiran Semester 1 Tahun Ajaran 2024/2025</p>
            
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th class="text-center">H</th>
                                <th class="text-center">I</th>
                                <th class="text-center">S</th>
                                <th class="text-center">A</th>
                                <th class="text-center">%</th>
                            </tr>
                        </thead>
                        <tbody id="absenTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
             <!-- TEACHER ACTIONS -->
             <div id="teacherActions" style="margin-top: 20px; display: none; justify-content: flex-end;">
                 <button onclick="handleSaveAbsen()" class="btn-primary">ğŸ’¾ Simpan Absensi</button>
             </div>
        </main>
    </div>

    <script src="js/data.js"></script>
    <script>
        checkAuth();
        const user = getCurrentUser();
        const isTeacher = user.role === 'teacher';

        if (isTeacher) {
            document.getElementById('teacherActions').style.display = 'flex';
        }

        function renderTable() {
            const tbody = document.getElementById('absenTableBody');
            tbody.innerHTML = '';
            const students = getStudents();

            students.forEach((s, index) => {
                const tr = document.createElement('tr');
                const stats = s.stats;
                
                // Calc percentage: Assumed total days = sum of all or fixed? 
                // Let's assume total days is sum of current entries for now or fixed 15 like previous static data.
                // Previous static had 15 total days for H (hadir).
                // Let's calculate total as H+I+S+A.
                const total = parseInt(stats.h) + parseInt(stats.i) + parseInt(stats.s) + parseInt(stats.a);
                const percent = total === 0 ? 0 : Math.round((parseInt(stats.h) / total) * 100);
                
                let gradeClass = 'grade-a';
                if (percent < 90) gradeClass = 'grade-b';
                if (percent < 75) gradeClass = 'grade-d';

                let rowHtml = `<td>${index + 1}</td>
                               <td>${s.name}</td>`;
                
                if (isTeacher) {
                    rowHtml += `
                        <td class="text-center"><input type="number" class="grade-input" style="width:40px" value="${stats.h}" data-id="${s.id}" data-stat="h"></td>
                        <td class="text-center"><input type="number" class="grade-input" style="width:40px" value="${stats.i}" data-id="${s.id}" data-stat="i"></td>
                        <td class="text-center"><input type="number" class="grade-input" style="width:40px" value="${stats.s}" data-id="${s.id}" data-stat="s"></td>
                        <td class="text-center"><input type="number" class="grade-input" style="width:40px" value="${stats.a}" data-id="${s.id}" data-stat="a"></td>
                        <td class="text-center"><span class="${gradeClass}">${percent}%</span></td>
                    `;
                } else {
                    rowHtml += `
                        <td class="text-center"><span class="status-badge status-hadir">${stats.h}</span></td>
                        <td class="text-center">${stats.i > 0 ? '<span class="status-badge status-izin">'+stats.i+'</span>' : '0'}</td>
                        <td class="text-center">${stats.s > 0 ? '<span class="status-badge status-sakit">'+stats.s+'</span>' : '0'}</td>
                        <td class="text-center">${stats.a > 0 ? '<span class="status-badge status-alpha">'+stats.a+'</span>' : '0'}</td>
                        <td class="text-center"><span class="${gradeClass}">${percent}%</span></td>
                    `;
                }
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
            if (!isTeacher) highlightCurrentUser();
        }

        function handleSaveAbsen() {
             if (!confirm('Simpan data absensi?')) return;
             const inputs = document.querySelectorAll('.grade-input');
             const dataToUpdate = getStudents();
             
             inputs.forEach(input => {
                 const id = input.getAttribute('data-id');
                 const stat = input.getAttribute('data-stat');
                 const val = input.value;
                 const student = dataToUpdate.find(s => s.id === id);
                 if (student) student.stats[stat] = Number(val);
             });
             
             saveStudents(dataToUpdate);
             alert('Data Absensi Tersimpan!');
             renderTable();
        }

        renderTable();
    </script>
</body>
</html>
